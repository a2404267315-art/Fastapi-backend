events {
    worker_connections 2048;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    # 允许上传文件的大小
    client_max_body_size 20M;

    # --- DDoS 防护 (Nginx 层限流) ---
    # 定义限流区域: 按 IP (binary_remote_addr) 限流, 10M 内存可存 16万 IP, 限制每秒 50 请求
    limit_req_zone $binary_remote_addr zone=ip_limit:10m rate=50r/s;

    # 负载均衡配置 - 多个 backend 实例
    upstream fastapi_backend {
        # 使用 least_conn 策略，将请求发送到连接数最少的服务器
        least_conn;
        
        # Docker Compose 会自动解析服务名到多个容器
        server backend:8000 max_fails=3 fail_timeout=30s;
    }

    server {
        listen 80;
        server_name localhost;

        # --- 文档白名单 (不限流) ---
        location = /openapi.json {
            proxy_pass http://fastapi_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location = /docs {
            proxy_pass http://fastapi_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # 必须带上 CSP 否则 Swagger UI 无法加载
            add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fastapi.tiangolo.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com; img-src 'self' data: https://fastapi.tiangolo.com https://cdn.jsdelivr.net; font-src 'self' https://fonts.gstatic.com;" always;
        }



        location / {
            # 应用限流: 允许突发 100 个请求 (burst), 不延迟处理 (nodelay)
            limit_req zone=ip_limit burst=100 nodelay;
            
            proxy_pass http://fastapi_backend;
            
            # 必须设置的头信息
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # 连接超时配置
            proxy_read_timeout 300s;
            proxy_connect_timeout 75s;
            proxy_send_timeout 300s;
            
            # 启用 HTTP/1.1 长连接
            proxy_http_version 1.1;
            proxy_set_header Connection "";

            # --- 安全响应头 ---
            # 禁止被嵌入 iframe (防点击劫持)
            add_header X-Frame-Options "DENY" always;
            # 禁止浏览器猜测 Content-Type
            add_header X-Content-Type-Options "nosniff" always;
            # 启用 XSS 过滤
            add_header X-XSS-Protection "1; mode=block" always;
            # 基础 CSP (生产环境需根据实际情况调整)
            # 基础 CSP (允许 Swagger UI 的 CDN)
            add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fastapi.tiangolo.com; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com; img-src 'self' data: https://fastapi.tiangolo.com https://cdn.jsdelivr.net; font-src 'self' https://fonts.gstatic.com;" always;
            # HSTS (强制 HTTPS, 生产环境开启)
            # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        }

        # 健康检查端点
        location /health {
            return 200 'OK';
            add_header Content-Type text/plain;
        }
    }
}