<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyrene Simulator - 极简前端</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>

<body>
    <div id="app">
        <!-- 未登录状态：显示登录/注册 -->
        <div v-if="!token">
            <h2>用户认证</h2>
            <div>
                <h3>登录</h3>
                <input v-model="loginForm.username" placeholder="用户名">
                <input v-model="loginForm.password" type="password" placeholder="密码">
                <button @click="login">登录</button>
            </div>
            <hr>
            <div>
                <h3>注册</h3>
                <input v-model="registerForm.user_name" placeholder="用户名">
                <input v-model="registerForm.user_password" type="password" placeholder="密码(至少8位)">
                <br>
                <img :src="captchaUrl" @click="refreshCaptcha" style="cursor:pointer" title="点击刷新">
                <input v-model="registerForm.captcha_code" placeholder="验证码">
                <button @click="register">注册</button>
            </div>
        </div>

        <!-- 已登录状态：显示对话功能 -->
        <div v-else>
            <h2>欢迎, {{ userName }}! <button @click="logout">登出</button></h2>
            <hr>

            <!-- 获取角色列表 -->
            <div>
                <h3>角色列表</h3>
                <button @click="getCharacters">获取角色</button>
                <ul>
                    <li v-for="c in characters" :key="c.id">{{ c.name }}</li>
                </ul>
            </div>
            <hr>

            <!-- 创建对话 -->
            <div>
                <h3>创建新对话</h3>
                <input v-model="newChat.character_name" placeholder="角色名">
                <input v-model="newChat.chat_name" placeholder="对话名">
                <button @click="createChat">创建</button>
            </div>
            <hr>

            <!-- 获取对话列表 -->
            <div>
                <h3>我的对话列表</h3>
                <button @click="getConversations">刷新列表</button>
                <ul>
                    <li v-for="conv in conversations" :key="conv.id" @click="selectChat(conv)" style="cursor:pointer">
                        ID:{{ conv.id }} - {{ conv.title }}
                    </li>
                </ul>
            </div>
            <hr>

            <!-- 聊天区域 -->
            <div v-if="currentChatId">
                <h3>当前对话 ID: {{ currentChatId }}</h3>
                <button @click="getChatHistory">加载历史</button>
                <div style="border:1px solid #ccc;height:200px;overflow:auto;padding:5px;">
                    <div v-for="(msg, i) in chatHistory" :key="i">
                        <b>{{ msg.role }}:</b> {{ msg.parts ? msg.parts[0].text : msg.content }}
                    </div>
                </div>
                <div>
                    <input v-model="message" placeholder="输入消息" style="width:300px;">
                    <select v-model="model">
                        <option>deepseek-chat</option>
                    </select>
                    <button @click="sendMessage">发送</button>
                </div>
                <div>
                    <b>AI回复 (流式):</b>
                    <pre>{{ streamResponse }}</pre>
                </div>
            </div>
        </div>

        <!-- 状态消息 -->
        <hr>
        <div style="color:red;">{{ errorMsg }}</div>
        <div style="color:green;">{{ successMsg }}</div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1';

        const { createApp, ref, onMounted } = Vue;

        createApp({
            setup() {
                // 状态
                const token = ref(localStorage.getItem('token') || '');
                const userName = ref(localStorage.getItem('userName') || '');
                const captchaId = ref('');
                const captchaUrl = ref('');

                const errorMsg = ref('');
                const successMsg = ref('');

                // 登录表单
                const loginForm = ref({ username: '', password: '' });
                // 注册表单
                const registerForm = ref({ user_name: '', user_password: '', captcha_code: '' });

                // 对话相关
                const characters = ref([]);
                const conversations = ref([]);
                const currentChatId = ref(null);
                const chatHistory = ref([]);
                const message = ref('');
                const model = ref('deepseek_chat');
                const streamResponse = ref('');
                const newChat = ref({ character_name: '', chat_name: '' });

                // 刷新验证码
                const refreshCaptcha = async () => {
                    try {
                        const resp = await fetch(`${API_BASE}/user_auth/captcha`);
                        captchaId.value = resp.headers.get('X-Captcha-ID');
                        const blob = await resp.blob();
                        captchaUrl.value = URL.createObjectURL(blob);
                    } catch (e) {
                        errorMsg.value = '获取验证码失败: ' + e.message;
                    }
                };

                // 登录
                const login = async () => {
                    errorMsg.value = '';
                    successMsg.value = '';
                    try {
                        const formData = new FormData();
                        formData.append('username', loginForm.value.username);
                        formData.append('password', loginForm.value.password);
                        const resp = await fetch(`${API_BASE}/user_auth/login`, {
                            method: 'POST',
                            body: formData
                        });
                        const data = await resp.json();
                        if (data.access_token) {
                            token.value = data.access_token;
                            userName.value = data.user_name;
                            localStorage.setItem('token', data.access_token);
                            localStorage.setItem('userName', data.user_name);
                            successMsg.value = '登录成功！';
                        } else {
                            errorMsg.value = data.detail || '登录失败';
                        }
                    } catch (e) {
                        errorMsg.value = '登录异常: ' + e.message;
                    }
                };

                // 注册
                const register = async () => {
                    errorMsg.value = '';
                    successMsg.value = '';
                    try {
                        const resp = await fetch(`${API_BASE}/user_auth/register`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                ...registerForm.value,
                                captcha_id: captchaId.value
                            })
                        });
                        const data = await resp.json();
                        if (data.status === 'ok') {
                            successMsg.value = '注册成功！请登录';
                            refreshCaptcha();
                        } else {
                            errorMsg.value = data.detail || '注册失败';
                            refreshCaptcha();
                        }
                    } catch (e) {
                        errorMsg.value = '注册异常: ' + e.message;
                    }
                };

                // 登出
                const logout = () => {
                    token.value = '';
                    userName.value = '';
                    localStorage.removeItem('token');
                    localStorage.removeItem('userName');
                };

                // 带Token的请求头
                const authHeaders = () => ({
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token.value}`
                });

                // 获取角色列表
                const getCharacters = async () => {
                    errorMsg.value = '';
                    try {
                        const resp = await fetch(`${API_BASE}/get_character_name`, {
                            method: 'POST',
                            headers: authHeaders(),
                            body: JSON.stringify({ page_size: 20, page_number: 1 })
                        });
                        const data = await resp.json();
                        characters.value = data || [];
                    } catch (e) {
                        errorMsg.value = '获取角色失败: ' + e.message;
                    }
                };

                // 创建对话
                const createChat = async () => {
                    errorMsg.value = '';
                    successMsg.value = '';
                    try {
                        const resp = await fetch(`${API_BASE}/create_chat`, {
                            method: 'POST',
                            headers: authHeaders(),
                            body: JSON.stringify(newChat.value)
                        });
                        const data = await resp.json();
                        if (data.chat_id) {
                            successMsg.value = `对话创建成功, ID: ${data.chat_id}`;
                            getConversations();
                        } else {
                            errorMsg.value = data.detail || '创建失败';
                        }
                    } catch (e) {
                        errorMsg.value = '创建对话异常: ' + e.message;
                    }
                };

                // 获取对话列表
                const getConversations = async () => {
                    errorMsg.value = '';
                    try {
                        const resp = await fetch(`${API_BASE}/get_current_user_conversation`, {
                            method: 'POST',
                            headers: authHeaders(),
                            body: JSON.stringify({ page_size: 20, page_number: 1 })
                        });
                        const data = await resp.json();
                        conversations.value = data[0] || [];
                    } catch (e) {
                        errorMsg.value = '获取对话列表失败: ' + e.message;
                    }
                };

                // 选择对话
                const selectChat = (conv) => {
                    currentChatId.value = conv.id;
                    chatHistory.value = [];
                    streamResponse.value = '';
                };

                // 获取聊天历史
                const getChatHistory = async () => {
                    errorMsg.value = '';
                    try {
                        const resp = await fetch(`${API_BASE}/get_chat_history`, {
                            method: 'POST',
                            headers: authHeaders(),
                            body: JSON.stringify({ chat_id: currentChatId.value })
                        });
                        const data = await resp.json();
                        chatHistory.value = data.history_chat || [];
                    } catch (e) {
                        errorMsg.value = '获取历史失败: ' + e.message;
                    }
                };

                // 发送消息 (流式)
                const sendMessage = async () => {
                    errorMsg.value = '';
                    streamResponse.value = '';
                    try {
                        const resp = await fetch(`${API_BASE}/send_message`, {
                            method: 'POST',
                            headers: authHeaders(),
                            body: JSON.stringify({
                                chat_id: currentChatId.value,
                                message: message.value,
                                model: model.value,
                                whether_regenerate: false
                            })
                        });
                        const reader = resp.body.getReader();
                        const decoder = new TextDecoder();
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            streamResponse.value += decoder.decode(value);
                        }
                        message.value = '';
                    } catch (e) {
                        errorMsg.value = '发送消息失败: ' + e.message;
                    }
                };

                onMounted(() => {
                    if (!token.value) {
                        refreshCaptcha();
                    }
                });

                return {
                    token, userName, captchaUrl,
                    loginForm, registerForm,
                    errorMsg, successMsg,
                    characters, conversations,
                    currentChatId, chatHistory,
                    message, model, streamResponse,
                    newChat,
                    refreshCaptcha, login, register, logout,
                    getCharacters, createChat, getConversations,
                    selectChat, getChatHistory, sendMessage
                };
            }
        }).mount('#app');
    </script>
</body>

</html>